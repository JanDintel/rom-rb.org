<!DOCTYPE html><html><head><link href="/images/favicon.png" rel="icon" type="image/png" /><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="ROM &raquo; Tutorials &raquo; Rails &raquo; Displaying tasks via @rom_rb" name="twitter:description" /><meta content="ROM &raquo; Tutorials &raquo; Rails &raquo; Displaying tasks" name="description" /><title>ROM &raquo; Tutorials &raquo; Rails &raquo; Displaying tasks</title><style type="text/css">.highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #d0d0d0;
  background-color: #151515;
}
.highlight .err {
  color: #151515;
  background-color: #ac4142;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #505050;
}
.highlight .cp {
  color: #f4bf75;
}
.highlight .nt {
  color: #f4bf75;
}
.highlight .o, .highlight .ow {
  color: #d0d0d0;
}
.highlight .p, .highlight .pi {
  color: #d0d0d0;
}
.highlight .gi {
  color: #90a959;
}
.highlight .gd {
  color: #ac4142;
}
.highlight .gh {
  color: #6a9fb5;
  background-color: #151515;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #aa759f;
}
.highlight .kc {
  color: #d28445;
}
.highlight .kt {
  color: #d28445;
}
.highlight .kd {
  color: #d28445;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #90a959;
}
.highlight .sr {
  color: #75b5aa;
}
.highlight .si {
  color: #8f5536;
}
.highlight .se {
  color: #8f5536;
}
.highlight .nn {
  color: #f4bf75;
}
.highlight .nc {
  color: #f4bf75;
}
.highlight .no {
  color: #f4bf75;
}
.highlight .na {
  color: #6a9fb5;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #90a959;
}
.highlight .ss {
  color: #90a959;
}</style><link href="../../../stylesheets/all.css" rel="stylesheet" type="text/css" /><script src="../../../javascripts/all.js" type="text/javascript"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" type="text/javascript"></script><script type="text/javascript">$(function() {
  var share = new Share(".share")
});
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-2573270-5', 'auto');
ga('send', 'pageview');</script></head><body class="tutorials tutorials_rails tutorials_rails_displaying-tasks tutorials_rails_displaying-tasks_index"><div class="page-wrapper"><div class="info-alert-top" role="alert">Content based on ROM 0.6.0.rc1, expect final release in the upcoming days</div><header><nav class="navbar navbar-default navbar-static-top"><div class="navbar-inner"><div class="container"><a class="navbar-brand" href="/">Ruby Object Mapper</a><ul class="nav navbar-nav"><li class=""><a class="" href="/introduction">Introduction</a></li><li class=""><a class="" href="/tutorials">Tutorials</a></li><li class="dropdown"><a class="dropdown-toggle" role="button" data-toggle="dropdown" href="#">API Reference <span class='caret'/></a><ul class="dropdown-menu" role="menu"><li><a href="http://www.rubydoc.info/gems/rom">rom</a></li><li><a href="http://www.rubydoc.info/gems/rom-sql">rom-sql</a></li><li><a href="http://www.rubydoc.info/gems/rom-mongo">rom-mongo</a></li><li><a href="http://www.rubydoc.info/gems/rom-rails">rom-rails</a></li></ul></li><li class=""><a class="" href="/blog">Blog</a></li><li class=""><a class="" href="/contribute">Contribute</a></li><li class=""><a class="" href="/status">Status</a></li></ul></div></div></nav></header><div class="container"><div class="content"><div class="row"><div class="col-md-3"><ul class="nav nav-pills nav-stacked"><li class="nav-heading"><a class="nav-heading" href="/tutorials/todo-app-with-rails">Todo App with Rails</a></li></ul></div><div class="col-md-9"><div class="page-header"><h1>Tutorials &raquo; Rails &raquo; Displaying tasks</h1></div><div class="page-article"><h2 id="displaying-tasks">Displaying Tasks</h2>

<p>Now that we’ve <a href="/tutorials/rails/getting-started">integrated ROM with Rails</a> and briefly visited ROM’s high level API for relations and commands, it’s time to dive a little deeper into .</p>

<p>This section is focused on how to select data using ROM relations and construct model objects using ROM mappers. After reading this, you’ll have an understanding of:</p>

<ul>
<li>How to use ROM relations to set up read queries.</li>
<li>How to integrate ROM with Rails controllers.</li>
<li>What ROM relations are, and how they differ from ActiveRecord and Sequel models.</li>
<li>What ROM mappers are, and how they can be used to build rich domain models.</li>
</ul>

<p>We’ll start by building an index page to display all the tasks in our todo list.</p>

<h3 id="an-index-action">An Index Action</h3>

<p>To read data from the tasks relation that we set up previously, make a route to a new controller in <code>app/controllers/tasks_controller.rb</code>.</p>

<p>If you don’t want to do this manually, you can generate the controller with the following command:</p>
<pre class="highlight shell"><code>bin/rails generate controller tasks
</code></pre>

<p>Hook in the tasks relation to the index action of the controller:</p>
<pre class="highlight ruby"><code><span class="c1"># app/controllers/tasks_controller.rb</span>

<span class="k">class</span> <span class="nc">TasksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">tasks: </span><span class="n">rom</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>To run this, start the Rails server with the following command:</p>
<pre class="highlight shell"><code>bin/rails server
</code></pre>

<p>Sending a request to this action at <code>http://localhost:3000/tasks</code> will give us an error due to a missing template. So let’s fill that in now:</p>
<pre class="highlight erb"><code># app/views/tasks/index.html.erb

<span class="nt">&lt;h1&gt;</span>Tasks#index<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">tasks</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">task</span><span class="p">[</span><span class="ss">:text</span><span class="p">]</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre>

<p>And just like that, we’re listing tasks!</p>

<p>Notice that we’re using raw hash keys to access the task attributes in the template. This is because the relation doesn’t yet know how to map the list of tasks to a particular model.</p>

<p>Before addressing this, let’s first explore how to set up more granular queries on the relation.</p>

<h3 id="filtering">Filtering</h3>

<p>The specific capabilities of a relation depend on the dataset adapter it’s configured with. Here, we’re using <a href="https://github.com/rom-rb/rom-sql">rom-sql</a>, which gives us access to the <a href="http://sequel.jeremyevans.net/rdoc/classes/Sequel/Dataset.html">Sequel Dataset API</a>.</p>

<p>To filter the list of tasks based on whether or not the tasks are complete, add the following methods <code>by_complete</code> and <code>by_incomplete</code> to the relation:</p>
<pre class="highlight ruby"><code><span class="c1"># app/relations/tasks.rb</span>

<span class="k">class</span> <span class="nc">Tasks</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">dataset</span> <span class="ss">:tasks</span>

  <span class="k">def</span> <span class="nf">by_complete</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">is_complete: </span><span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">by_incomplete</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">is_complete: </span><span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Note that in Sequel, <code>filter</code> can also be used as an alias for <code>where</code>. Use whatever style you prefer.</p>

<p>To render these filtered lists in the index template, we’ll introduce the new concept of a task status.</p>

<p>The database table for tasks has a boolean <code>is_complete</code> field, but <code>status</code> maps more closely to the mental model for tasks that we want in our user interface.</p>

<p>In practice of course, we’d like our database fields to map as directly as possible to the data structures and concepts in our application, but this isn’t always possible or straightforward.</p>

<p>Here, we’re going to deliberately use the subtle mismatch between <code>status</code> and <code>is_complete</code> to highlight some of the capabilities of ROM and how its philosophy differs from ActiveRecord.</p>

<p>Start by adding the status filters directly to the index action:</p>
<pre class="highlight ruby"><code><span class="c1"># app/controllers/tasks_controller.rb</span>

<span class="k">class</span> <span class="nc">TasksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:status</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'complete'</span>
      <span class="n">tasks</span> <span class="o">=</span> <span class="n">rom</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">by_complete</span>
    <span class="k">elsif</span> <span class="n">params</span><span class="p">[</span><span class="ss">:status</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'incomplete'</span>
      <span class="n">tasks</span> <span class="o">=</span> <span class="n">rom</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">by_incomplete</span>
    <span class="k">else</span>
      <span class="n">tasks</span> <span class="o">=</span> <span class="n">rom</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">render</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">tasks: </span><span class="n">tasks</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>This works, but it’s a far more messy and ad-hoc than we’d like. Let’s quickly refactor it to get rid of a few code smells.</p>

<p>First, we’ll push access to the relation behind a private method in the controller. Because our route handles matching valid parameters, the extra conditional in the action isn’t needed—we can call the associated method on the relation by sending the parameter name as a symbol.</p>
<pre class="highlight ruby"><code><span class="c1"># app/controllers/tasks_controller.rb</span>

<span class="k">class</span> <span class="nc">TasksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">tasks: </span><span class="n">index_view</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:status</span><span class="p">])</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">index_view</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span>
      <span class="n">rom</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">rom</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Another approach we could consider is to lift the index view into the relation itself. This has the advantage of separating </p>

<h3 id="method-chaining">Method chaining</h3>

<p>Let’s dive a little deeper, and break down what happens when we access the <code>tasks</code> relation on the ROM environment:</p>

<p>From a Rails perspective, one way to look at the high level ROM API is a supercharged tightly packed implementation of the registry pattern.</p>

<p>https://mattbrictson.com/registry-pattern</p>
<pre class="highlight ruby"><code><span class="n">rom</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span>
</code></pre>

<p>This gives us a freshly loaded instance of the relation to play with.</p>

<p>Our Rails app template generated a <code>Tasks</code> relation class in <code>app/relations/task.rb</code>. To add specific query capabilities to the relation, we add them as methods in this class.</p>

<p>Any methods we define on the relation class become application specific behaviour.</p>

<p>For example, we may want to order our list of tasks by priority:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Task</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">priority</span>
    <span class="n">order</span><span class="p">(</span><span class="ss">priority: :desc</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Depending on the specific methods defined on that relation’s class, </p>

<p>In the app we’re building here, the <code>tasks</code> relation refers directly to the database table we’re querying, but the key thing to understand is that it doesn’t have to.</p>

<p>We can use the same interface of named relations to access data from anywhere—REST APIs, NoSQL databases, even YAML and CSV files. All data comes back through a uniform interface that responds to <code>#each</code> and yields hashes.</p>

<p>Everything else on a relation is defined by its specific class.</p>

<p>You can see this in action by adding new query methods to <code>app/relations/task.rb</code> and seeing how they affects the .</p>
<pre class="highlight plaintext"><code>
</code></pre>
<div class="page-article-edit"><hr /><div class="share pull-left"></div><p class="pull-right">Edit this article on <a href="https://github.com/rom-rb/rom-rb.org/tree/master/source/doc-pages/tutorials/rails/displaying-tasks.md">GitHub</a></p></div></div></div></div></div></div></div><footer><div class="container"><div class="social"><div class="github"><iframe allowtransparency="true" frameborder="0" height="20" scrolling="0" src="http://ghbtns.com/github-btn.html?user=rom-rb&repo=rom&type=watch&count=true" width="110"></iframe></div><div class="twitter"><a class="twitter-follow-button" data-show-count="true" data-show-screen-name="false" href="https://twitter.com/rom_rb">Follow</a><script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div><div class="muted copyright">Ruby Object Mapper &copy; 2014-2015</div></div></footer></body></html>