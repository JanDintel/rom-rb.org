<!DOCTYPE html><html><head><link href="/images/favicon.png" rel="icon" type="image/png" /><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="ROM &raquo;  via @rom_rb" name="twitter:description" /><meta content="ROM &raquo; " name="description" /><title>ROM &raquo; </title><style type="text/css">.highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #d0d0d0;
  background-color: #151515;
}
.highlight .err {
  color: #151515;
  background-color: #ac4142;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #505050;
}
.highlight .cp {
  color: #f4bf75;
}
.highlight .nt {
  color: #f4bf75;
}
.highlight .o, .highlight .ow {
  color: #d0d0d0;
}
.highlight .p, .highlight .pi {
  color: #d0d0d0;
}
.highlight .gi {
  color: #90a959;
}
.highlight .gd {
  color: #ac4142;
}
.highlight .gh {
  color: #6a9fb5;
  background-color: #151515;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #aa759f;
}
.highlight .kc {
  color: #d28445;
}
.highlight .kt {
  color: #d28445;
}
.highlight .kd {
  color: #d28445;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #90a959;
}
.highlight .sr {
  color: #75b5aa;
}
.highlight .si {
  color: #8f5536;
}
.highlight .se {
  color: #8f5536;
}
.highlight .nn {
  color: #f4bf75;
}
.highlight .nc {
  color: #f4bf75;
}
.highlight .no {
  color: #f4bf75;
}
.highlight .na {
  color: #6a9fb5;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #90a959;
}
.highlight .ss {
  color: #90a959;
}</style><link href="../../../../stylesheets/all.css" rel="stylesheet" type="text/css" /><script src="../../../../javascripts/all.js" type="text/javascript"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" type="text/javascript"></script><script type="text/javascript">$(function() {
  var share = new Share(".share")
});
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-2573270-5', 'auto');
ga('send', 'pageview');</script></head><body class="doc-pages doc-pages_tutorials doc-pages_tutorials_rails doc-pages_tutorials_rails_task-mapper doc-pages_tutorials_rails_task-mapper_index"><div class="page-wrapper"><header><nav class="navbar navbar-default navbar-fixed-top"><div class="navbar-inner"><div class="container"><a class="navbar-brand" href="/">Ruby Object Mapper</a><ul class="nav navbar-nav"><li class=""><a class="" href="/introduction">Introduction</a></li><li class=""><a class="" href="/tutorials">Tutorials</a></li><li class="dropdown"><a class="dropdown-toggle" role="button" data-toggle="dropdown" href="#">API Reference <span class='caret'/></a><ul class="dropdown-menu" role="menu"><li><a href="http://www.rubydoc.info/gems/rom">rom</a></li><li><a href="http://www.rubydoc.info/gems/rom-sql">rom-sql</a></li><li><a href="http://www.rubydoc.info/gems/rom-mongo">rom-mongo</a></li><li><a href="http://www.rubydoc.info/gems/rom-rails">rom-rails</a></li></ul></li><li class=""><a class="" href="/blog">Blog</a></li><li class=""><a class="" href="/status">Status</a></li></ul><div class="social"><div class="github"><iframe allowtransparency="true" frameborder="0" height="20" scrolling="0" src="http://ghbtns.com/github-btn.html?user=rom-rb&repo=rom&type=watch&count=true" width="110"></iframe></div><div class="twitter"><a class="twitter-follow-button" data-show-count="true" data-show-screen-name="false" href="https://twitter.com/rom_rb">Follow</a><script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div></div></div></nav></header><div class="container"><div class="content"><h2>Setting up Task mapper</h2>

<p>We just extended our task relation with a method for the index view. The data
returned from this method is an array of hashes &ndash; the most basic representation
of data in ROM.</p>

<p>These hashes may be all you need but, more often than not, you&rsquo;ll want to use a
proper domain object. The &ldquo;M&rdquo; in ROM stands for <strong>M</strong>apper and it is through a
mapper that we&rsquo;ll transform our hashes into something a little more useful.</p>

<p>To start, we&rsquo;ll need to define an object for the mapper to use. It can be
whatever kind of object you like. Be it a plain PORO or something more
sophisticated. The only contract is that it must accept an attribute hash in the
constructor.</p>

<p>We&rsquo;re using
<a href="https://github.com/solnic/virtus/#value-objects">Virtus value objects</a>
because they already support the required attribute hash construction and nice
bonus features out-of-the-box like equality methods.</p>
<pre class="highlight ruby"><code><span class="c1"># app/models/task.rb</span>

<span class="k">class</span> <span class="nc">Task</span>
  <span class="kp">include</span> <span class="no">Virtus</span><span class="p">.</span><span class="nf">value_object</span><span class="p">(</span><span class="ss">coerce: </span><span class="kp">false</span><span class="p">)</span>

  <span class="n">values</span> <span class="k">do</span>
    <span class="n">attribute</span> <span class="ss">:id</span><span class="p">,</span> <span class="no">Integer</span>
    <span class="n">attribute</span> <span class="ss">:title</span><span class="p">,</span> <span class="no">String</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>With an entity class defined we can simply instruct the task mapper to use it.</p>
<pre class="highlight ruby"><code><span class="c1"># app/mappers/tasks.rb</span>

<span class="no">ROM</span><span class="p">.</span><span class="nf">mappers</span> <span class="k">do</span>
  <span class="n">define</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">model</span> <span class="no">Task</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Notice how little we&rsquo;ve had to add to the mapper definition. Running the specs again
will illustrate how this change impacts our application:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>bin/rspec

  <span class="c"># ...</span>

  expected: <span class="o">[{</span>:id<span class="o">=</span>&gt;1, :title<span class="o">=</span>&gt;<span class="s2">"Task One"</span><span class="o">}</span>, <span class="o">{</span>:id<span class="o">=</span>&gt;2, :title<span class="o">=</span>&gt;<span class="s2">"Task Two"</span><span class="o">}]</span>
       got: <span class="o">[</span><span class="c">#&lt;Task id=1 title="Task One"&gt;, #&lt;Task id=2 title="Task Two"&gt;]</span>

  <span class="c"># ...</span>
</code></pre>

<p>The task relation spec is now failing as it expects hashes. Update it to
reflect the changes we made:</p>
<pre class="highlight ruby"><code><span class="c1"># spec/relations/task_spec.rb</span>

<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="n">describe</span> <span class="s1">'Tasks relation'</span> <span class="k">do</span>
  <span class="n">fixtures</span> <span class="ss">:tasks</span>

  <span class="n">describe</span> <span class="s1">'index_view'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'returns tasks sorted by name'</span> <span class="k">do</span>
      <span class="n">tasks</span> <span class="o">=</span> <span class="no">ROM</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">index_view</span>
      <span class="n">task_one</span> <span class="o">=</span> <span class="no">Task</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">title: </span><span class="s2">"Task One"</span><span class="p">)</span>
      <span class="n">task_two</span> <span class="o">=</span> <span class="no">Task</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">id: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">title: </span><span class="s2">"Task Two"</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="nf">to_a</span><span class="p">).</span><span class="nf">to</span> <span class="n">eql</span><span class="p">([</span><span class="n">task_one</span><span class="p">,</span> <span class="n">task_two</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>And we&rsquo;re green!</p>
<pre class="highlight ruby"><code><span class="err">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">rspec</span> <span class="n">spec</span><span class="o">/</span><span class="n">relations</span><span class="o">/</span><span class="n">tasks_spec</span><span class="p">.</span><span class="nf">rb</span>
<span class="o">.</span>

<span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">00746</span> <span class="n">seconds</span> <span class="p">(</span><span class="n">files</span> <span class="n">took</span> <span class="mi">0</span><span class="o">.</span><span class="mi">22541</span> <span class="n">seconds</span> <span class="n">to</span> <span class="nb">load</span><span class="p">)</span>
<span class="mi">1</span> <span class="n">example</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span>
</code></pre>

<h3>Using dedicated task relation for index view</h3>

<p>We&rsquo;ve defined the relation for the index view and a mapping to return a <code>Task</code>
instead of hashes. It&rsquo;s time to update the controller and the index template
for the changes.</p>

<p>If you remember, our goal was that the list of tasks was ordered by the task
title. We created the <code>index_view</code> relation method for tasks.</p>
<pre class="highlight ruby"><code><span class="c1"># app/controllers/tasks_controller.rb</span>

<span class="k">class</span> <span class="nc">TasksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">tasks: </span><span class="n">rom</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">index_view</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>The view is now getting a list of <code>Task</code> objects so we want to use the accessor
method instead of <code>[]</code>.</p>
<pre class="highlight erb"><code># app/views/tasks/index.html.erb

<span class="nt">&lt;h1&gt;</span>Tasks#index<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">tasks</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">task</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre>

<h3>Summing up</h3>

<p>We &ldquo;graduated&rdquo; from simple hashes to a rich entity object to ease data access
in the views. The <code>Task</code> entity looks similar to the standard <code>ActiveRecord</code>
objects we normally see in a Rails project. There are some important differences
however. Our <code>Task</code>:</p>

<ul>
<li>is a <a href="http://www.c2.com/cgi/wiki?ValueObject">value object</a>. <strong>(Remember that
ROM can use any object that accepts a hash of attributes.)</strong></li>
<li>exposes only required information &ndash; the title attribute</li>
<li>doesn&rsquo;t support validation</li>
<li>doesn&rsquo;t support persistence</li>
<li>can&rsquo;t be changed</li>
<li>has no database query DSL</li>
<li>doesn&rsquo;t support serialization</li>
</ul>

<p>The above features aren&rsquo;t needed to meet our design goals. The ROM team
believes that each layer of an application should only have the data, and data
access, it requires, and no more. Looking at the controller above, the action is
still expressive &ndash; we know what data is being passed to the view. We still have
the attribute accessor in the view so no surprises there.</p>

<p>We don&rsquo;t need to understand a large amount of unrelated and unnecessary
features in a context where they&rsquo;re not required.</p>

<p>Okay, only include what we need, sounds great. Now we need to create and update
tasks. In <a href="/tutorials/rails/managing-tasks">managing tasks</a> we will see how to
implement these actions.</p>
</div></div></div><footer><div class="container"><div class="muted copyright">Ruby Object Mapper &copy; 2014</div></div></footer></body></html>