<!DOCTYPE html><html><head><link href="/images/favicon.png" rel="icon" type="image/png" /><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="ROM &raquo;  via @rom_rb" name="twitter:description" /><meta content="ROM &raquo; " name="description" /><title>ROM &raquo; </title><style type="text/css">.highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #d0d0d0;
  background-color: #151515;
}
.highlight .err {
  color: #151515;
  background-color: #ac4142;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #505050;
}
.highlight .cp {
  color: #f4bf75;
}
.highlight .nt {
  color: #f4bf75;
}
.highlight .o, .highlight .ow {
  color: #d0d0d0;
}
.highlight .p, .highlight .pi {
  color: #d0d0d0;
}
.highlight .gi {
  color: #90a959;
}
.highlight .gd {
  color: #ac4142;
}
.highlight .gh {
  color: #6a9fb5;
  background-color: #151515;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #aa759f;
}
.highlight .kc {
  color: #d28445;
}
.highlight .kt {
  color: #d28445;
}
.highlight .kd {
  color: #d28445;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #90a959;
}
.highlight .sr {
  color: #75b5aa;
}
.highlight .si {
  color: #8f5536;
}
.highlight .se {
  color: #8f5536;
}
.highlight .nn {
  color: #f4bf75;
}
.highlight .nc {
  color: #f4bf75;
}
.highlight .no {
  color: #f4bf75;
}
.highlight .na {
  color: #6a9fb5;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #90a959;
}
.highlight .ss {
  color: #90a959;
}</style><link href="../../../../stylesheets/all.css" rel="stylesheet" type="text/css" /><script src="../../../../javascripts/all.js" type="text/javascript"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" type="text/javascript"></script><script type="text/javascript">$(function() {
  var share = new Share(".share")
});
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-2573270-5', 'auto');
ga('send', 'pageview');</script></head><body class="doc-pages doc-pages_tutorials doc-pages_tutorials_rails doc-pages_tutorials_rails_managing-tasks doc-pages_tutorials_rails_managing-tasks_index"><div class="page-wrapper"><header><nav class="navbar navbar-default navbar-fixed-top"><div class="navbar-inner"><div class="container"><a class="navbar-brand" href="/">Ruby Object Mapper</a><ul class="nav navbar-nav"><li class=""><a class="" href="/introduction">Introduction</a></li><li class=""><a class="" href="/tutorials">Tutorials</a></li><li class="dropdown"><a class="dropdown-toggle" role="button" data-toggle="dropdown" href="#">API Reference <span class='caret'/></a><ul class="dropdown-menu" role="menu"><li><a href="http://www.rubydoc.info/gems/rom">rom</a></li><li><a href="http://www.rubydoc.info/gems/rom-sql">rom-sql</a></li><li><a href="http://www.rubydoc.info/gems/rom-mongo">rom-mongo</a></li><li><a href="http://www.rubydoc.info/gems/rom-rails">rom-rails</a></li></ul></li><li class=""><a class="" href="/blog">Blog</a></li><li class=""><a class="" href="/status">Status</a></li></ul><div class="social"><div class="github"><iframe allowtransparency="true" frameborder="0" height="20" scrolling="0" src="http://ghbtns.com/github-btn.html?user=rom-rb&repo=rom&type=watch&count=true" width="110"></iframe></div><div class="twitter"><a class="twitter-follow-button" data-show-count="true" data-show-screen-name="false" href="https://twitter.com/rom_rb">Follow</a><script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div></div></div></nav></header><div class="container"><div class="content"><h2>Managing tasks</h2>

<p>In this section you will learn how to implement create &amp; update actions in
tasks controller using ROM <a href="/introduction/commands">commands</a>. Along the way
we will extend relations and integrate our rom functionality more fully into
the application.</p>

<p>ROM strives to create clean separations for the different responsibilities of an
application. Commands allow us to create explicit ways to manipulate our
data.</p>

<p>Basic commands were automatically created for you when you generated the app
skeleton. You can find them in <code>app/commands</code>.</p>
<pre class="highlight ruby"><code><span class="c1"># app/commands/tasks.rb</span>

<span class="no">ROM</span><span class="p">.</span><span class="nf">commands</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">define</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">result</span> <span class="ss">:one</span>
  <span class="k">end</span>

  <span class="n">define</span><span class="p">(</span><span class="ss">:update</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">result</span> <span class="ss">:one</span>
  <span class="k">end</span>

  <span class="n">define</span><span class="p">(</span><span class="ss">:delete</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">result</span> <span class="ss">:one</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>It may be disorienting to have data manipulation functionality like this
outside of the model if you come from a standard Rails application background.
Querying data and changing data are often mixed together in ORMs. Keep in mind
that ROM wants these things pulled apart. Let&rsquo;s see how our application looks
when we use these commands.</p>

<h3>Creating tasks</h3>

<p>We will need a view and a controller action to take advantage of the create
command. As a reminder, the <code>create</code> command is implemented like this (from
above):</p>
<pre class="highlight ruby"><code><span class="no">ROM</span><span class="p">.</span><span class="nf">commands</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">define</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">result</span> <span class="ss">:one</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>

<h4>Add the &ldquo;new&rdquo; scenario</h4>

<p>Add a new scenario to the tasks feature spec for adding tasks:</p>
<pre class="highlight ruby"><code><span class="c1"># spec/features/tasks_spec.rb</span>

<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="n">feature</span> <span class="s1">'Tasks'</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">scenario</span> <span class="s1">'I can add a new task'</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">new_task_path</span>

    <span class="n">find</span><span class="p">(</span><span class="s1">'#task_title'</span><span class="p">).</span><span class="nf">set</span><span class="p">(</span><span class="s1">'Write tests'</span><span class="p">)</span>
    <span class="n">click_on</span> <span class="s1">'Save'</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Tasks#index'</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Write tests'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p><em>No need to add the route since our application template added <code>resources
:tasks</code> to our routes.rb file.</em></p>

<h4>Make it pass</h4>

<h5>Add the <code>new</code> template</h5>
<pre class="highlight erb"><code># app/views/tasks/new.html.erb

<span class="nt">&lt;h1&gt;</span>Tasks#new<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="ss">:task</span><span class="p">,</span> <span class="ss">url: </span><span class="n">tasks_path</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:title</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s1">'Save'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>

<h5>Add the <code>create</code> action</h5>
<pre class="highlight ruby"><code><span class="c1"># app/controllers/tasks_controller.rb</span>

<span class="k">class</span> <span class="nc">TasksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ..</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="c1"># Rails 'strong parameters'</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:task</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span>
    <span class="n">rom</span><span class="p">.</span><span class="nf">command</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">try</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">redirect_to</span> <span class="ss">:tasks</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>This is enough to make the test pass:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>bin/rspec spec/features/tasks_spec.rb
..

Finished <span class="k">in </span>0.13225 seconds <span class="o">(</span>files took 0.33654 seconds to load<span class="o">)</span>
2 examples, 0 failures
</code></pre>

<p>Now we have an interface for creating new tasks. It doesn&rsquo;t look all that
different from what we&rsquo;re used to outside of the usage of <code>rom.command</code>.</p>

<h3>Updating tasks</h3>

<p>The command for updating looks like this:</p>
<pre class="highlight ruby"><code><span class="no">ROM</span><span class="p">.</span><span class="nf">commands</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">define</span><span class="p">(</span><span class="ss">:update</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">result</span> <span class="ss">:one</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>

<p>To update tasks we&rsquo;ll need a view and controller action for <code>edit</code> along with
an action for <code>update</code>.</p>

<h4>Add the &ldquo;edit&rdquo; scenario</h4>
<pre class="highlight ruby"><code><span class="c1"># spec/features/tasks_spec.rb</span>

<span class="n">feature</span> <span class="s1">'Tasks'</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">scenario</span> <span class="s1">'I can edit a task'</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">tasks_path</span>

    <span class="n">click_on</span> <span class="s1">'Task One'</span>

    <span class="n">find</span><span class="p">(</span><span class="s1">'#task_title'</span><span class="p">).</span><span class="nf">set</span><span class="p">(</span><span class="s1">'Updated Task One'</span><span class="p">)</span>
    <span class="n">click_on</span> <span class="s1">'Save'</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Tasks#index'</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Updated Task One'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<h4>Add the <code>edit</code> template</h4>
<pre class="highlight erb"><code># app/views/tasks/edit.html.erb

<span class="nt">&lt;h1&gt;</span>Tasks#edit<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="ss">:task</span><span class="p">,</span> <span class="ss">url: </span><span class="n">task_path</span><span class="p">(</span><span class="ss">id: </span><span class="n">task</span><span class="p">.</span><span class="nf">id</span><span class="p">),</span> <span class="ss">method: :put</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:title</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s1">'Save'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>

<h4>Add the <code>edit</code> action</h4>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">TasksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">rom</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">by_id</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">first</span>
    <span class="n">render</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">task: </span><span class="n">task</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Oops! We are trying to use the <code>#by_id</code> relation method above. We should probably
add it. If you remember, we can create new methods on a relation quite easily.
Let&rsquo;s take a short detour and take care of that.</p>

<h4>Specify <code>by_id</code></h4>
<pre class="highlight ruby"><code><span class="c1"># spec/relations/tasks_spec.rb</span>

<span class="n">describe</span> <span class="s1">'Tasks relation'</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">describe</span> <span class="s1">'by_id'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'returns a task by id'</span> <span class="k">do</span>
      <span class="n">task</span> <span class="o">=</span> <span class="no">ROM</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">by_id</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">first</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="nf">title</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Task One'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Currently ROM relations are all enumerable so we need to add <code>#first</code> to get
the single object.</p>

<h4>Implement <code>by_id</code></h4>
<pre class="highlight ruby"><code><span class="c1"># app/relations/tasks.rb</span>

<span class="no">ROM</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">id: </span><span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>

<p><em>Don&rsquo;t forget: <code>where(id: id)</code> is a method on the Sequel adapter.</em></p>

<p>Since we already added a mapper for tasks the result of this method is an
instance of the <code>Task</code> value object.</p>

<p>We&rsquo;re close but we need a way to update the task.</p>

<h4>Add the <code>update</code> action</h4>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">TasksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># Rails 'strong parameters'</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:task</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span>

    <span class="n">rom</span><span class="p">.</span><span class="nf">command</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">try</span> <span class="p">{</span> <span class="n">update</span><span class="p">(</span><span class="ss">:by_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">).</span><span class="nf">set</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">redirect_to</span> <span class="ss">:tasks</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<h4>Small update to <code>index</code> view</h4>

<p>And our scenario requires that task titles be links in the index view:</p>
<pre class="highlight erb"><code># app/views/tasks/index.html.erb

<span class="nt">&lt;h1&gt;</span>Tasks#index<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">tasks</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">task</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">edit_task_path</span><span class="p">(</span><span class="ss">id: </span><span class="n">task</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre>

<h4>Passing tests!</h4>

<p>Just like that, our tests should pass:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>bin/rspec spec/features/tasks_spec.rb
...

Finished <span class="k">in </span>0.17617 seconds <span class="o">(</span>files took 0.35988 seconds to load<span class="o">)</span>
3 examples, 0 failures
</code></pre>

<h4>What&rsquo;s next?</h4>

<p>We don&rsquo;t have a way to delete tasks so our management is incomplete. It turns
out that the delete action is so trivial you should be able to do it on your
own. Start with that scenario and work inward toward the command.</p>

<p>Validations and error handling are sorely lacking in our implementation. That
seems like a good thing to cover <a href="/tutorials/rails/validations">next</a>.</p>
</div></div></div><footer><div class="container"><div class="muted copyright">Ruby Object Mapper &copy; 2014</div></div></footer></body></html>